 ![[Pasted image 20240216132910.png]]

![[Pasted image 20240216133325.png]]

---

## 1. Introduction to the Metasploit Framework
### Developed by HD Moore in 2003

##### + It provides penetration testers with a robust infrastructure required to automate every stage of the penetration testing life cycle.

---

## Metasploit Editions
+ Metasploit Pro (Commercial) 
+ Metasploit Express (Commercial) 
+ Metasploit Framework(Community)

---
## Metasploit Community Edition
Metasploit Community Edition is a web based GUI front-end for the Metasploit Framework that simplifies network discovery and vulnerability identification.

![[Pasted image 20240216175632.png]]

---
## Armitage
#armitage-msfconsole 
Armitage is a free Java based GUI front-end for the Metasploit Framework that simplifies network discovery, exploitation and post exploitation.
![[Pasted image 20240216175857.png]]
### msfconsole 'un GUI versiyonu olarak düşünebiliriz. msfconsole ne yapabiliyorsa aynı yetenekler bunda da var.


---

## MSF Architecture

![[Pasted image 20240216230544.png]]
<span style="background:#d4b106">● The MSF libraries facilitate the execution of modules without having to write the code necessary in order to execute them.</span>

### MSF Modules

![[Pasted image 20240216231010.png]]
##### Payload bir exploit gerçekleştikten sonra hedef sistemde yürütülebilen bir malicious code'dur.

## Bize reverse shell'i veren exploit değildir. Payload'dır. Msfconsole'da run/exploit yazıp enter'a basınca msf önce exploit sayesinde sisteme erişir sonra payload ile bize reverse shell verir.


### Encoder
- Used to<span style="background:#d4b106"> encode payloads in order to avoid AV detection</span>. For example, <span style="background:#ff4d4f">shikata_ga_nai</span> is used to encode Windows payloads.
#### Tipik olarak windows sistemlerde Windows defender vardır. eğer biz payload'ı encode etmez isek Deffeder bizi yakalar.


### NOPS  
+ Used to ensure that payloads sizes are consistent and <span style="background:#d4b106">ensure the stability</span><span style="background:#d4b106"> of a payload</span> when executed.
### Auxiliary 
+ A module that is used to perform additional functionality like <span style="background:#d4b106">port scanning and enumeration.</span>
### Auxiliary 'de bu modele eşlik eden bir payload yok. Yardımcı modul olarak düşün ve sadece tespit yapar hedefe erişim, reverse shell falan sağlamaz. Çünkü payload yok bu modul de.


---

## MSF Payload Types

### 1. Non-Staged Payload 
 Payload that is sent to the target system as is along with the exploit. 
##### Exploit'in yanında göderiliyor.
### 2. Staged Payload 
A staged payload is <span style="background:#d4b106">sent to the target in two parts</span>, whereby:
The first part (stager) contains a payload that is used to establish a reverse connection back to the attacker, download the second part of the payload (stage) and execute it.
![[Pasted image 20240216232832.png]]

---
## Meta-Interpreter #meterpreter 
The Meterpreter (Meta-Interpreter) payload is an advanced multi-functional payload that is executed in memory on the target system making it <span style="background:#ff4d4f">difficult to detect.</span>
It communicates over a stager socket and provides an attacker with an interactive command interpreter on the target system that facilitates the execution of system commands, file system navigation, keylogging and much
more.


### Meterpreter hedefe download yapılmıyor veya disk üzerinde execute yapılmıyor çalıştırılmıyor. Memory üzerinde Ram üzerinde çalıştırılıyor. 
**RAM Üzerinde Çalıştırmanın Avantajları:**

- <span style="background:#ff4d4f">**Disk İz Bırakmaz:**</span> Meterpreter, RAM üzerinde çalıştırıldığında diske herhangi bir dosya yazmaz. Bu da, saldırganın varlığını gizlemesine ve tespit edilmesini zorlaştırmasına yardımcı olur.
- <span style="background:#ff4d4f">**Daha Hızlı Performans:**</span> Meterpreter, diske erişmek yerine RAM'e doğrudan erişerek daha hızlı çalışabilir.
- <span style="background:#ff4d4f">**Uçucu Yapısı:**</span> Meterpreter, RAM üzerinde çalıştığı için sistem yeniden başlatıldığında kaybolur. Bu da, saldırganın izlerini silmesine ve kalıcı bir etki bırakmamasına yardımcı olur.




---
## MSF File System Structure
![[Pasted image 20240216233813.png]]

##### Modules
/usr/share/metasploit-framework/modules



![[Pasted image 20240216234209.png]]

## ~/.ms4/modules
### Bu directory'de OWN Custom Module'ler bulunur.
## Root klasöründe duruyor. Kendine özel module ayırmak istediğinde buraya koy
![[Pasted image 20240216235758.png]]

---

### Auxiliary Module
![[Pasted image 20240216234310.png]]
![[Pasted image 20240216234359.png]]



---
---
## Penetration Testing With The Metasploit Framework


##### Penetration Testing Execution Standard
![[Pasted image 20240217005048.png]]
## Penetration Testing Phases
![[Pasted image 20240217005113.png]]

## Penetration Testing With MSF
![[Pasted image 20240217005203.png]]


---

## Installing & Configuring The Metasploit Framework

#nessus 
![[Pasted image 20240217202042.png]]
#nessus-password 

---

## The Metasploit Framework Database

+ The Metasploit Framework Database (msfdb) is an integral part of the Metasploit Framework and is used to keep track of all your assessments, host data scans etc.
+ The Metasploit Framework uses PostgreSQL as the primary database server, as a result, we will also need to ensure that the #PostgreSQL database service is running and configured correctly. #msf-sql #msf-database
+ The Metasploit Framework Database also facilitates the importation and storage of scan results from various third party tools like #nmap-msf and #Nessus-msf.

---
## + Launch MSFconsole!
+ Update our repositories and upgrade our Metasploit Framework to the latest version.

```
sudo apt-get update && sudo apt-get install metasploit-framework -y
```

+ Start and enable the PostgreSQL database service.

```
sudo systemctl enable postgresql
```

```
sudo systemctl start postgresql
```
```
sudo systemctl status postgresql
```
![[Pasted image 20240218233013.png]]

```
sudo msfdb
```
![[Pasted image 20240218233139.png]]
```
msfdb init
```

![[Pasted image 20240218233250.png]]
+ Initialize the Metasploit Framework Database (msfdb).
### msfconsole

##### Yukarıdaki süreçte Postgresql msfconsole.2un kullanacağı sql'i aktif hale getirdik ve çalıştırdık. Sonrasında msfdb database'yi init yaptık yani initialize ve start yaptık.
##### Artık msfconsole ile çalışırken yapyığımız işlemleri host'ları hedefleri kendi database'ine kaydedebileceğiz.

#### Eğer database ile bir problem yaşarsak her zaman varolanı silip baştan initialize yapabiliriz. Data'ları kaybedeceksin ama sorunlar çözülmüş olacak.

```
msfdb reinit  
# delete and reinitialize the database

```
![[Pasted image 20240218233732.png]]

```
msfdb status
```
![[Pasted image 20240218233834.png]]
TCP localhost:5432 (LISTEN)
TCP localhost:5432 (LISTEN
### Database bu portlarda dinleme yapıyor ve hazır.

---
>msfconsole

### db_    tab tuşuna basarsan database ile kullanılacak komutlar karşına gelir.

![[Pasted image 20240218234331.png]]
![[Pasted image 20240218234237.png]]

---
# MSFconsole Fundamentals
![[Pasted image 20240218234547.png]]

### Standart bilgilerimizin yanısıra 
##### " MSFconsole allows you to set both local variable values or <span style="background:#ff4d4f">global variable values</span>."
setg RHOST
![[Pasted image 20240218234904.png]]

---
## Creating & Managing Workspaces

### CONTROL + L -->> BİZİM TERMİNALİ SIFIRLAR YANİ CLEAR KODU
##### #clear --> #CTRL-L

---
## Core Commands
### msf>?
![[Pasted image 20240219000223.png]]

## Examples
![[Pasted image 20240219000340.png]]

## msf> show all
![[Pasted image 20240219000552.png]]
### show all bize içerde ne var ne yok gösterir.

## Sadece exploits göreceksen show exploits

![[Pasted image 20240219000724.png]]

---
## msf6> show -h
##### Sadece show command hakkında bize bilgi verir.
![[Pasted image 20240219000838.png]]
##### "show" command are: all, encoders, nops, exploits, payloads, auxiliary, post, plugins, info, options, favorites



---
### PORT SCAN SEARCH
![[Pasted image 20240219001004.png]]

---
## msf6> search -h
![[Pasted image 20240219001658.png]]
![[Pasted image 20240219001725.png]]
### search cve:2009 type:exploit platform:-linux 
![[Pasted image 20240219001851.png]]

![[Pasted image 20240219002052.png]]
### msf6 > search cve:2024 type:exploit platform:windows
![[Pasted image 20240219002156.png]]

---

### Şimdi biz exploit ararken belirli bir spesifik exoloiti aratabiliriz. Örneğin eternalblue

![[Pasted image 20240219002457.png]]
### Şimdi burada biz use 0 deyip ilk exploiti seçeceğiz ama bize standart bir payload verecek.
#### Ancak bu payload bizim yapacağımız işleme , işletim sistemi mimarisine uymayabilir.

![[Pasted image 20240219002630.png]]
### Default Payload windows/x64/meterpreter/reverse_tcp bunu vermiş örneğin. Ya bizimsaldıracağımız sistem x86 mimarideyse ???

## set payload windows/x86/meterpreter/reverse_tcp

```
msf6 > search type:payload platform:windows  x86 reverse_tcp meterpreter

```
![[Pasted image 20240219003448.png]]

### Yine search komutu ile ne arıyorsak payload olarak belirtip bulunduğumuz duruma uygun payload arayıp bulup set payload ile kullanabiliriz.

---

## msf connect command
#msf-connect-command
##### msf6> connect -h
![[Pasted image 20240219003913.png]]
##### Netcat benzeri bir araç kullanarak bir ana makine ile iletişim kurun ve bu iletişim sırasında sunucuda yapılandırılmış olabilecek herhangi bir session pivoting özelliğinden yararlanarak yetkisiz erişim elde etmeye çalışın.

### connect 10.0.2.5 22
![[Pasted image 20240219004347.png]]
##### Port 80 i denedik ama port kapalı 22 de ssh çalışıyor bize banner grabbing yaptı ve versiyonunu verdi.

---
## Creating & Managing Workspaces

### msfconsole database ilgilendiren bir işlem yapacaksan önce 
## db_status komutunu çalıştır. database aktif olup olmadığını kontrol etmek için.

### msfconsole default olarak bir workspace çalıştırır ve yaptıgın işlemleri burada kaydeder. 10.0.2.5 hostuna yaptığın bir attack mesela burada kaydedilecektir. Ancak eğer arka arkaya farklı client'lara  yaptığın pentest 'ler için ayrı workspace kullanmazsan bu işlemler birbirine karışabilir . Bu yüzden yeni workspace'ler yaratmak senin çalışmalarını düzenleyecektir.

---
```
workspace -h
```

![[Pasted image 20240219091411.png]]

![[Pasted image 20240219091429.png]]
![[Pasted image 20240219091447.png]]
##### Örneğin bu iki host'la pentest yapmışım ve direk default workspace'e kaydederi bunu düzenlemek için yeni workspace'ler oluşturmalısın.

```
workspace -a TEST
```
#workspace-ekleme
#msf-workspace
![[Pasted image 20240219091746.png]]

#workspace-seçme 
![[Pasted image 20240219091828.png]]
```
workspace TEST
```
##### Bu şekilde yeni workspace oluşturulup seçilir. 
#### Kırmızı renkle yazılı olan geçerli workspace dir.

### TEST workspace seçili olduğunda görüldüğü gibi hiçbir hosts tanımlı değil daha önce default'ta attack yaptığımız için default workspace'de tanımlı.


#### Workspace Silmek
![[Pasted image 20240219092927.png]]
```
workspace -d TEST
```
![[Pasted image 20240219093024.png]]

### Workspace yaniden adlandırma rename -r ve workspace listeleme -l
![[Pasted image 20240219093254.png]]

---
# Port Scanning & Enumeration With Nmap
#msf-nmap

Auxiliary Modules

Auxiliary modules can be used during the information gathering phase of a penetration test as well as the post exploitation phase.

We can also use auxiliary modules to discover hosts and perform port scanning on a different network subnet after we have obtained initial access on a target system.

## Lab Infrastructure
![[Pasted image 20240219101512.png]]

+ We will then utilize our foothold to access other systems on a different network subnet (pivoting).
+ We will then utilize auxiliary modules to scan for open ports on the second target.

### Biz LAB'ı şu şekilde kurduk
### 1. Makine Kali Linux Bridge Adapter da IP:192.168.1.5
#### 2.BridgeAdapter :192.168.1.6 diğeri Nat Network :10.0.2.6
##### 3. Makine Metasploitable 2 Nat Network'de : 10.0.2.7
### 4. Makine win 7 Nat Network'de 10.0.2.15


---
## Nmap -- MSFCONSOLE
![[Pasted image 20240219120334.png]]
### .normal bir nmap taramaıs başlatıldı fakat karşı taraf windows olduğu için ping atılmasına izin vermedi bizde -Pn #nmap-windows taraması için bu taramayı başlattık. Ping atmadan tarama yapılacak.

---

##### nmap -Pn 10.0.2.6 -sV -O 
![[Pasted image 20240219120656.png]]
### Bu taramayı zaten biliyoruz O/S ve versiyonları tarayacak karşı taraf windows olduğu için ping scan yapacağız.

## Önemli olan bu scan sonuçlarını MSF içine atmak

---
## Nmap ---> Msfconsole
![[Pasted image 20240219120942.png]]

## Çok Önemli
>[!important] Nmap sonuçlarını biz msfconsole içine atabilmemiz için sonuçların output'unu XML #XML çeklinde almamız lazım ki msfconsole bunları anlamladırabilsin. 

#nmap-xml-msfconsole


##### nmap 192.168.1.5 -sV -O -oX nmap-msfconsole
```
nmap 192.168.1.5 -sV -O -oX nmap-msfconsole

```
##### Biz bunu /home/kali/Documents/eJPT directory'e kaydettik buradan da msfconsole içine çekeceğiz. 

---

### Importing Nmap Scan --> MSFCONSOLE

##### 1. service postgresql start
```
service postgresql start

```

##### 2. db_status
![[Pasted image 20240219122608.png]]
##### 3. Yeni bir Client dolayısıyla yeni workspace oluştur add ve <span style="background:#d4b106">workspace olarak SEÇ</span>
```
workspace -a mts3
```
```
workspace mts3
```
![[Pasted image 20240219122842.png]]

##### 4. Şimdi scan result'ı import etmeye geldi sıra.
### db_import /home/kali/Documents/eJPT/nmap-msfconsole

```
db_import /home/kali/Documents/eJPT/nmap-msfconsole

```
![[Pasted image 20240219123114.png]]
##### 5. hosts
![[Pasted image 20240219123215.png]]

##### 6. services
### services komutuyla nmap taramasındaki -sV komutunun çıktılarını bize verir
![[Pasted image 20240219123344.png]]

---

## Ayrıca msfconsole açıkken nmap scan yapmamızı sağlıyor ve sonuç olarak bunun sonuçlarını kendi database'ine kaydediyor.

### Taramayı external yapıp sonra dan manuel olarak scan result'ı atmak istemiyorsan msfconsole içinden de bu işlemi yapabilirsin.

---
### Şimdi mts2 'yi açıp bunun için ayrı bir workspace oluşturup sonun içine nmap scani msfconsole içinden yapıp atacağız.
#### Tabi bunun için bridgeye geçtik 192.168.1.20

![[Pasted image 20240219124119.png]]
### db_nmap 192.168.1.20 -sV -O
```
db_nmap 192.168.1.20 -sV -O
```
![[Pasted image 20240219124404.png]]
### services
![[Pasted image 20240219124445.png]]
### hosts
![[Pasted image 20240219124505.png]]
### vulns
![[Pasted image 20240219124601.png]]
###### Eğer -sC default script kullasaydık bize vulns'ları da verirdi veya aggressive scan -A ile de verirdi.

---
---

## Port Scanning With Auxiliary Modules

###  msf6> search type:auxiliary portscan
### use 5
###  set RHOST 10.0.2.8
###  run
###  hosts
###  services
![[Pasted image 20240219200742.png]]


+ Auxiliary modules are used to perform functionality like scanning, <span style="background:#d4b106">discovery and fuzzing.</span>
+ We can use auxiliary modules to perform both <span style="background:#d4b106">TCP & UDP port scanning as well as enumerating information from services like FTP, SSH, HTTP etc</span>.
+ Auxiliary modules can be used during the information gathering phase of a penetration test 
### as well as the post exploitation phase.

+ We can also use auxiliary modules to<span style="background:#d4b106"> discover hosts</span> and <span style="background:#d4b106">perform port scanning</span> on a different network subnet after we have obtained initial access on a target system.
---

## Nmap var zenmap var rustscan var neden ben msfconsole'a ihtiyaç duyayım port scan için veya host scan için.

### Post exploitation için önemli bu durum.

##### Diyelim ki bir pentest'deyiz ve ilk target'a erişim sağladık. Sonra hızlı bir kontrolden sonra bir internal network'ün parçası olduğumuzu gördük. 
## Bu bilgi bizim için altın madeni değerindedir--> Çünkü exploit edilecek bir sürü target daha var demektir.

### Biz bu network'deki makinelere erişim sağlayamıyoruz çünkü elimizde IP adresleri yok veya external bir network'e bunların zaten erişimi yok. İlk access sağladığımız makine sayesinde bunlara erişeceğiz. Pivoting yapacağız. 

## İŞTE BURADA MSFCONSOLE'UN DEĞERİ ORTAYA ÇIKIYOR. BU SİSTEMLERDE NMAP YOK TARAMAYI YAPAMAZSIN NETWORKDEKİ MAKİNELER İÇİN
#### iLK ERİŞİM SAĞLADIĞIN MAKİNEYE NMAP         EXECUTABLE'I VEYA BINARY                         -->>TRANSFER ETMEDİĞİN SÜRECE O INTERNAL NETWORKDEKİ BEBELERİ SCAN EDEMEZSİN
![[Pasted image 20240219193206.png]]

---
![[Pasted image 20240219195544.png]]
### Şimdi olay şudur ki--->>> Biz kalimizi nat networke aldık sonra msf3 'ü  hem nat network hem de internal networke aldık ip'sini 127.0.0.2 yaptık net mask 255.0.0.0 yaptık.
#### msf3 internal network için
```
ifconfig lo 127.0.0.3 netmask 255.0.0.0
```

### msf2 internal network için 
```
ifconfig lo 127.0.0.2 netmask 255.0.0.0
```

### Herker görmesi gerekeni görüyor. Biz şimdi msf3 'ten meterpreter shell alacağız sonra burada aldığımız meterpreter shell ile hiç aynı ağda olmadığımız erişimimizin olmadığı sadece msf3'ten dolayı bağımızın olduğu msf2'ye bir port scan yapacaz msfconsole ile.

---
## Önemli Bilgi #curl 
>[!warning]  Biz eğer web browser'ımız yoksa sitede ne var ne yok nasıl göreceğiz curl ile görebiliriz bunu.

![[Pasted image 20240219201711.png]]
###  Normal terminalde de bu şekilde çıktı alabiliriz.

---

### #xoda exploit

### Öğretmenin anlattığı dersteki makinede curl ile bakılan http server.' da xoda isminde bir uygulama kullanılıyor bunun da zaafiyeti var
![[Pasted image 20240219202005.png]]
##### Öğretmen bunu kullanıp meterpreter shell alacak biz ise msf3'e msfvenomdan ürettiğimiz payload yukledik python3 -m http.server ile. Bununla multihandler ile dinleme yapıp meterpreter shell'imizi aldık.
![[Pasted image 20240219202718.png]]
### set TARGETURI    /    root yaptı dikkat edelim karşımıza çıkarsa

---
![[Pasted image 20240219202829.png]]
### sysinfo

## Şimdi biz şunu anlamız lazım. Bu makine network'de nerede hangi subnette sağında solunda kim var ne oluyor ne yapıyor. ENUM time

### shell
### /bin/bash -i
### ifconfig
![[Pasted image 20240219203138.png]]
#### ifconfig çalıştırdık ki bizim ilk eriştiğimiz makine hangi subnetlere bağlı hangi adapter'ları var bunları görmemiz lazım.
### Öğretmeninki de bu mesela
![[Pasted image 20240219203313.png]]
##### eth0 ve eth1 diye 2 tane networke bağlı ve farklı subnetteler. Her IP adresi, bir ağdaki konumunu belirleyen bir subnet maskesine sahiptir. Subnet maskesi, IP adresinin hangi bitlerinin ağ kimliğini ve hangi bitlerinin cihaz kimliğini belirlediğini tanımlar.

>[!warning] 192.113.124.12 IP adresinin subnet maskesi 255.255.255.0 ise, ağ kimliği 192.113.124.0'dır.
>
>192.86.140.3 IP adresinin subnet maskesi 255.255.255.0 ise, ağ kimliği 192.86.140.0'dır.

---

## ÇOK ÖNEMLİ
### run autoroute -s 127.0.0.2
```
run autoroute -s 127.0.0.2
```
 
 
 ![[Pasted image 20240219204600.png]]
### Biz ifconfig ile aldığımız bilgilerde msf3 127.0.0.2 diye bir ip adres ile bir lo networke bağlı buraya autoroute yaptık. ne komut çalıştırsak butaya da bizim ilk eriştiğimiz msf3 üzerinden gönderecek.

---
### msf6> background
### search portscan
### use 5
![[Pasted image 20240219204809.png]]
### options
### set RHOST 127.0.0.2
## run
![[Pasted image 20240219204943.png]]

## MSF3 bizim pivot pointimiz oldu ve bu sayede buna bağlı kim varsa ifconfig ile bağlı olduğu ağları tespit ettik ve buraya autoroute yaptık. Buradan sonra aynı ağdaymışız gibi RHOST'ları ayarlayabiliriz.

 ---

## Msfconsole UDP_sweep
#udp_sweep
#msf-udp

### Pentest yaparken UDP portlarınu da enum yapmayı unutmayalım

![[Pasted image 20240219205528.png]]
### set RHOST 127.0.0.2
### run
![[Pasted image 20240219205834.png]]
>[!info] **Keşfedilen Hizmetler:
>- **"Discovered Portmap on 127.0.0.2:111":** Hedef makinede 127.0.0.2 IP adresinde ve 111 numaralı portta Portmap hizmetinin açık olduğunu bildirir. Portmap, RPC (Remote Procedure Call) hizmetlerini yönetmek için kullanılır. 
>- **"Discovered NetBIOS on 127.0.0.2:137":** Hedef makinede 127.0.0.2 IP adresinde ve 137 numaralı portta NetBIOS hizmetinin açık olduğunu gösterir. NetBIOS, Windows ağlarında dosya paylaşımı, yazıcı erişimi ve diğer ağ iletişimi için kullanılır.
**3. Ek Bilgiler:** - **"100000 v4 TCP(111), 100000 v3 TCP(111), ...":** Portmap hizmetinin farklı sürümlerini (v4, v3, v2) ve iletişim için kullandığı TCP ve UDP protokollerini listeler.
**Sonuç:**
Bu çıktı, 127.0.0.2 IP adresindeki makinede Portmap ve NetBIOS hizmetlerinin açık olduğunu ve bu hizmetlerin sürümleri, protokolleri ve ilgili ayrıntıları hakkında bilgi sağlar. Bu bilgiler, daha ileri ağ keşifleri ve güvenlik testleri için kullanılabilir.


---
---
## FTP Enumeration
#ftp-msfconsole

#port21 
##### + FTP authentication utilizes a username and password combination, however, in some cases an improperly configured FTP server can be logged into anonymously.

---

### FTP web server'dan kendi sistemine veya kendi sisteminden server'a bilgi aktarabilirisin. Yalnzı credential lazım 

---

![[Pasted image 20240220112725.png]]

```
search type:auxiliary ftp scan
use 9
```
![[Pasted image 20240220112943.png]]

![[Pasted image 20240220113012.png]]
### Yaptığımız şey şudur. search ile auxiliary type secerek arattık ve vers,yonuna baktık. bu versiyona göre exoloit bakacağız. ftp başka portta çalışıyorsa options'dan değiştirmeyi unutma set RPORT ile.

## FTP auxiliary version

![[Pasted image 20240220113259.png]]
![[Pasted image 20240220113348.png]]
##### Dersteki öğretmenin makinesinde bu zaafiyet çıktı.

## FTP auxiliary BRUTE FORCE
## FTP auxiliary login brute force
```
auxiliary/scanner/ftp/ftp_login 
```
![[Pasted image 20240220114332.png]]
![[Pasted image 20240220114551.png]]

![[Pasted image 20240220114104.png]]

>[!warning] Şöyle bir durum var biz bruteforce attack'a devam ederken bir yandan gelen ilk credentials ile ftp server'a girmeye çalışırsak çünkü bir kaç tane bulma durumu ihtimali var attack devam ederken ftp ye girmeye çalışırsan service is not available diyebilir. Aynı şekilde bunu gerçek pentest yaparken yakalanma ihtimalini de arttırır.

---

### Msfconsole anonymous login check
#ftp-anonymous-login 
```
msf6 > search ftp anonymous
```
![[Pasted image 20240220115429.png]]

![[Pasted image 20240220115551.png]]

---
## SMB Enumeration
### Lan üzerinden veri <span style="background:#ff4d4f">paylaşımına</span> yarar.

#port139 #port445 

### + We can utilize auxiliary modules to enumerate the 
## SMB version, 
## shares, 
## users and 
## perform a brute-force attack 
### in order to identify users and passwords.

---
## SMB veya SAMBA nın versiyonunu bulmak zaafiyet analizi için önemlidir ayrıca bizim hedefin işletim sistemini bulmamıza da yarar.

---
## version enum
```
msf6 > search smb type:auxiliary smb_version
```
![[Pasted image 20240220125016.png]]
![[Pasted image 20240220125127.png]]

---
## users enum
```
msf6 > search smb users type:auxiliary 
```
![[Pasted image 20240220125414.png]]

```
use auxiliary/scanner/smb/smb_enumusers 
```

![[Pasted image 20240220125650.png]]
![[Pasted image 20240220130353.png]]

---

## Enumerate shares

### msf6> search smb shares enum
### search  type:auxiliary smb share

![[Pasted image 20240220130542.png]]
![[Pasted image 20240220130839.png]]

---

## SMB brute force
#smb-brute-force

#smb-login 

![[Pasted image 20240220131235.png]]
![[Pasted image 20240220131404.png]]

---
## smbclient #smbclient 

![[Pasted image 20240220132343.png]]
```
smbclient -L \\\\10.0.2.5\\ -U vagrant
```

## smbclient share'e bağlanma
#smbclient-share

```
smbclient -L \\\\10.0.2.5\\IPC$ -U vagrant
```


```
smbclient -L \\\\10.0.2.5\\C$ -U vagrant

```

![[Pasted image 20240220132753.png]]
![[Pasted image 20240220132836.png]]

----
##  Web Server Enumeration
#web-msfconsole 

+ We can utilize auxiliary modules to enumerate 
### the web server version, 
### HTTP headers, 
### brute-force directories and much more.

##### Examples of popular web servers are; Apache, Nginx and Microsoft IIS.

---
### https://www.google.com biz bunu yazdığımızda ne oluyor. Bizim browser'ımız DNS lookup yapıyor ve bunun IP nedir resolve yapmaya çalışıyor.
## IP adresini elde eder etmez de bir HTTP request  WEB SERVER'A  gonderiyor. 

### Web server da buna cevaben http response ile karşılık veriyor. 

### HTTP bir application layer protocoldür. Tipik olarak port 80 de çalışır.

## Ecryption için SSL certificate set up yaparsan da port 443 de HTTPs olarak çalışır.

##### Bir sürü enum yapabiliriz msfconsole ile bunlara http header da dahil ki bununla hangi teknoloji kullanılmış bunu belirleyebiliriz.

### search type:auxiliary name:http

Bu şekilde aratttığında bile 70 in üzrinde sonuç çıkıyor.

### search type:auxiliary name:http version
##### Version aratacaksak bu şekilde sürekli yaptığımız aramayı darlaştırmamız lazım.

![[Pasted image 20240220151549.png]]
### use 6
![[Pasted image 20240220151701.png]]

#### Önemli eğer biz #SSL ile ilgili bir HTTPs siteye enum yapsaydık burada 
### set SSL true 
#### yapmamız gerekirdi buraya dikkat.

---

## HTTP HEADER
##### http header'lar bizim için önemli. Eğer web server misconfig ise ve veri sızdırıyorsa bize çok fazla bilgi verebilir.

### msf6> search http_header
![[Pasted image 20240220152406.png]]

### Eğer spesifik bir directory'e enum yapmak istiyorsan TARGETURI bolumune yazmak gerekir.
![[Pasted image 20240220152459.png]]
##### Enum sonucuna göre html programlama diliyle yazılmış bir site apache server kullanıyorlar.



---
### robots.txt enum
![[Pasted image 20240220154144.png]]
![[Pasted image 20240220154345.png]]
### robots.txt tipik olarak sitenin /   root klasöründe bulunur bu yüzden PATH aynı kalacak

---
![[Pasted image 20240220154450.png]]
## /data
## /secure 
#### Bu directory'leri devoploper görünmesini istemiyormuş.
![[Pasted image 20240220154812.png]]
## curl http://192.140.160.3/data/
### curl ile data ya baktığımızda Index of /data yazması şu anlama gelir burada bir directory listelemesi yapmış yani buraya dosyalar kaydedilmiş olabilir demektir.


![[Pasted image 20240220155249.png]]

### /secure/ buna balıyoruz şimdi
### şimdi 401 hatası vermiş ve unauthorized demiş bizim yetkimizin olmadığını belirtmiş. 
## Bu şu anlama gelir bu directory demekki bir authentication form ile korunuyor.



---

## dir_scanner    HAngi directory'ler var bunları bulacak dirb gibi

![[Pasted image 20240220160355.png]]
### msf6 > search dir_scanner
![[Pasted image 20240220160445.png]]
![[Pasted image 20240220160600.png]]
### Burada #webdav #webmail gibi directory'lere dikkat edeceğiz bunlar auth gerektiren ve bizim için değerli directory'lerdir.

![[Pasted image 20240220160743.png]]

---

### Ayrıca file brute forcing de yapılabilir.
### search files_dir
![[Pasted image 20240220161139.png]]

### ext ---->> exyentionları da sınırlayabilirsin örneğin sadece PHP dosyalarını aratabilirsin.
### Dictionary değişimi de yapabilirsin /usr/share/wordlist bolumunde bir sürü wordlisy var

![[Pasted image 20240220161342.png]]

---

## http login
### search http_login

### http://10.0.2.7/phpMyAdmin/
![[Pasted image 20240220221848.png]]
### http_login

![[Pasted image 20240220161711.png]]

![[Pasted image 20240220221939.png]]
![[Pasted image 20240220221848.png]]
### Şimdi burada odaklanmamız gerekn durum şu . Öğretmenin yapmış olduğu enum esnasında attack yapacağı makine de /secure/ isminde bir directory buldu fakat bu secure directory 401 hatası verdi. yani 
## 401 Hatası Nedir?

## 401 hatası, bir web sitesine veya kaynağa erişmeye çalıştığınızda aldığınız bir hata kodudur. Bu hata, **isteğinizin yetkilendirilmediğini** ve sunucu tarafından reddedildiğini gösterir.


#### Yani bu sayfaya erişim için bir auth durumu söz konusu olabilir. Yalnız bunu mesela
![[Pasted image 20240220222321.png]]
### Bunu gibi bir durumla karıştırmamak lazım. Biz bu siteye bu directory'e girmek istiyoruz ve giriyoruz. sayfa hata alamadan açılıyor ve credentials'ları bir post ile göderirisek dogruysa girer buna brute force burp suite'le olur. Diğeri directory'e yetkiniz hiç yok diyor. Bu durumu 
## http_login ile çözersin
### auxiliary/scanner/http/http_login  

### set AUTH_URI /secure/
set RHOST 10.0.2.8

>[!warning] Bu bruteforece modullerde genel de brute force speed diye bişet çıkıyor.
>![[Pasted image 20240220222850.png]]
>Buna dikkat etmek gerekir eğer web server kapasitesi düşük bir sistemse bu ona DOS saldırısı gibi olup sistemi kilitleyebilir.

![[Pasted image 20240220223028.png]]
### Default olarak gelen options bu. Fakat burada USERPASS_FILE options'u unset yapmamız lazım çünkü biz zatan hem user_file hem de PASS_FILE 'a bakılacak yer atanmış bu hızımızı düşürür.

## unset USERPASS_FILE

![[Pasted image 20240220223241.png]]
# run

### Default olaran verilen wordlists başarılı olamadı yeni wordlist seçerek devam edeceğiz.

![[Pasted image 20240220223956.png]]
wordlistleri değiştir ve tekrar dene

### Yalnı bu şekilde çok uzun sürecektir hem username hem password. O yüzden bir username bulsak çok iyi olur.

![[Pasted image 20240220224431.png]]
### auxiliary/scanner/http/apache_userdir_enum 
![[Pasted image 20240220224402.png]]

![[Pasted image 20240220224642.png]]
### Bu yaptığımız enum sayesinde bir username yakaladık ve bunu şimdi http_login modulunde kullanacağız.
 
---
![[Pasted image 20240220224923.png]]
### Bir username bulduk ama modul option da sadece dosya olarak usernameler eklensin diye option var o zaman biz de 
### echo 'rooty' > username.txt 
#### bu komutla bir dosya ismi oluşturur onu veririz msfconcole'a

---

## MySQL Enumeration
#mysql-enum
MySQL is an open-source relational database management system based on 
### SQL (Structured Query Language).

+ It is typically used to <span style="background:#d4b106">store records, customer data, and is most commonly deployed to store web application data.</span>

### MYSQL #mysql genel olarak web application datayı depolamak için kullanılır buna dikkat edelim.
## Mesela Wordpress gibi bir application kurmak istediğinde wordpress senden içindeki dataları depolayacak bir yer isteyecektir. Bu da mysql .




+ MySQL utilizes TCP port 3306 by default, however, like any service it can be hosted on any open TCP port.
#port3306 #mysql-3306 #mysql 
+ We can utilize auxiliary modules to <span style="background:#d4b106">enumerate the version of MySQL,</span> <span style="background:#ff4d4f">perform brute-force attacks to identify passwords</span>, <span style="background:#d4b106">execute SQL queries</span> and much more.

### 1. auxiliary/scanner/mysql/mysql_version
### 2. auxiliary/scanner/mysql/mysql_login
### 3. auxiliary/admin/mysql/mysql_enum
### 4. auxiliary/admin/mysql/mysql_sql
### 5. auxiliary/scanner/mysql/mysql_file_enum
### 6. auxiliary/scanner/mysql/mysql_hashdump
### 7. auxiliary/scanner/mysql/mysql_schemadump
### 8. auxiliary/scanner/mysql/mysql_writable_dirs


---
### Burada şunu özellikle anlamamız lazım enumerate babamızın hayrına yapmıyoruz. Maksat cyber kill chain veya MITRE işlesin değil. Örneğin MYSQL brute force attack yapıyoruz ki credentials elimize geçsin hemen sonrasında mysql 'de ne var ne yok alabilmem için. Enum herşeyin başlangıcı çok önemli ama ele geçen bilginin her milimetresini kullanmak lazımdır.

## SQL query yaparak verileri çekeriz.

---
## Enum - MYSQL
### msf6 > search mysql type:auxiliary
![[Pasted image 20240221224134.png]]

### Her zamanki gibi ilk bakmamız gereken şey versiyonu olması lazım mysql'in ki bu versiyonun bir CVE'si var mı diye.

##### use auxiliary/scanner/mysql/mysql_version 

![[Pasted image 20240221224831.png]]
##### GÖrdüğümüz gibi MYSQL var mts3-win de ve versiyonu da 5.5.20-log

---
### Bulduğumuz versiyona ait bir exploit var ancak bruteforce yapıp credential almak gelir aklımıza

**use exploit/windows/mysql/mysql_payload**

---


msf6> search mysql_login

![[Pasted image 20240221225744.png]]
### burada username olarak vagrant'ı verdik.
##### pass_file olarak  /opt/rockyou.txt 'yi seçtik.

## bu auxiliary module tabiki otomatik olarak root olarak belirlemiş username'yi cunku root'u ele geçirirsen herşey ala geçmiş olur.

Biz vagrant isimli user'ı enum etiiğimiz için biliyoruz. O yüzden bildiğimiz yerden devam ediyoruz. Ayrıca root yerine administrator seçsek daha iyi olur cunku karsıdaki hedef windows.
![[Pasted image 20240221230137.png]]

---



---

![[Pasted image 20240221230926.png]]

## Hydra ile de #mysql-brute-hydra yapılabiliyor.


```
hydra -l root -e n -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt 10.0.2.5 mysql

```

![[Pasted image 20240222002537.png]]



----

![[Pasted image 20240221231510.png]]
![[Pasted image 20240221231927.png]]
### Mysql şifresi " " boşluk olduğu için direk sisteme giriyor. 

![[Pasted image 20240221232029.png]]
![[Pasted image 20240221232119.png]]


---

### Şimdi bizim MTS-3win de mysql root kullanıcına " " şifresiyle girme yetkisi vermiş. Burada bizim enum devam edecek.

##### msf6> search mysql_enum
![[Pasted image 20240221232324.png]]
##### Buradali modulun ismine baktığında admin klasörü altında olduğu için demekki bu benden credentials isteyecek demektir.

![[Pasted image 20240221232555.png]]
![[Pasted image 20240221232632.png]]

---
![[Pasted image 20240221232732.png]]

---
![[Pasted image 20240221232820.png]]
![[Pasted image 20240221232836.png]]
### Bu bölümler çok önemli çünkü hash'leri veriyor bize.


---
## MYSQL_SQL module
### Yapılacak en önemli enum'lardan birisi budur. Çünkü elimizde credentials var ve bunu tamamen mysql içeriği almada kullanabiliriz.
![[Pasted image 20240221233200.png]]

![[Pasted image 20240221233237.png]]
![[Pasted image 20240221233836.png]]

#### ÇOK ÖNEMLİ ŞİMDİ BURAYA DİKKAT

>[!warning] Bu module de SQL yazan yere SQL query de ne istiyorsak onu yazacağız ki zaten elimizde credentials var bu modul de gidip mysql'e giriş yapıp SELECT komutuyla istediğimizi alacak.

---
## SQL Veri Tabanındaki Her Şeyi Seçmek için Sorgu

Veri tabanındaki her şeyi seçmek için aşağıdaki basit sorguyu kullanabilirsiniz:

SQL

```
SELECT * FROM tüm_tablolar;
```

Bu sorgu, `tüm_tablolar` adında bir tablodan tüm sütunları ve satırları seçer.

**Eğer tüm tabloları değil de sadece belirli bir tabloyu seçmek isterseniz:**

SQL

```
SELECT * FROM tablo_adı;
```

**Belirli sütunları seçmek isterseniz:**

SQL

```
SELECT sütun_adı1, sütun_adı2 FROM tablo_adı;
```

**Belirli koşullara uyan satırları seçmek isterseniz:**

SQL

```
SELECT * FROM tablo_adı WHERE koşul;
```

**Örnekler:**

- Veri tabanındaki tüm verileri seçmek için:

SQL

```
SELECT * FROM tüm_tablolar;
```

- `kullanıcılar` tablosundaki tüm verileri seçmek için:

SQL

```
SELECT * FROM kullanıcılar;
```

- `kullanıcılar` tablosundaki `ad`, `soyad` ve `e-posta` sütunlarını seçmek için:

SQL

```
SELECT ad, soyad, e-posta FROM kullanıcılar;
```

- `kullanıcılar` tablosundaki `yaş`ı 18'den büyük olan tüm verileri seçmek için:

SQL

```
SELECT * FROM kullanıcılar WHERE yaş > 18;
```

**Notlar:**

- `tüm_tablolar` yerine, veri tabanınızdaki tüm tabloların adlarını içeren bir tablo listesi kullanabilirsiniz.
- `*` yerine, seçmek istediğiniz sütunların adlarını listeleyebilirsiniz.
- `koşul` yerine, WHERE ifadesinde kullanmak istediğiniz koşulu yazabilirsiniz.

---
### SQL SHOW BAŞLASIN
## 1. SET SQL SHOW DATABASES;

![[Pasted image 20240221234436.png]]

## 2. SET SQL use mysql;
![[Pasted image 20240221235112.png]]
### Herhangi bir output vermez çünkü sadece database içine girdi.

## Bu modul buradan sonra devam etmedi yeni bir enum modulune gidiyoruz. mysql_schema

---

## mysql_schema
![[Pasted image 20240222000038.png]]
![[Pasted image 20240222000226.png]]
![[Pasted image 20240222000310.png]]
![[Pasted image 20240222000332.png]]

### Bize bu şekilde getirdi. SQL query'leri yapmamızı kolaylaştırmış oldu.

---

## MSFCONSOLE LOOT COMMAND

#loot 
### Tüm ganimetleri bulunan ne varsa listelemek için kullanılır.
/root/.msf4/loot/20240221161130_mysql_10.0.2.5_mysql_schema_630615.txt
#### Bizim Kalimizde buraya kaydetmiş ganimetleri
#msf-loot 

---

## MSFCONSOLE CREDS COMMAND
![[Pasted image 20240222001607.png]]
#creds #mscreds 

![[Pasted image 20240222001650.png]]

---

## ÇOK ÖNEMLİ NOT - WORKSPACE
#### YUKARIDAKİ CREDS , HOSTS, SERVICES VEYA LOOY KOMUTLARINI KULLANDIK FAKAT HERSEYI BASTAN YAPMAK ZORUNDA KALDIM. BASTAN BIR WORKSPACE OLUSTURMADIGIM ICIN 10 DERS ONCESININ VERILERINI DE GOSTERDI BANA...   
### BUNUN 100 HOST'LU BIR ŞİRKETİN PENTESTI ESNASINDA OLDUGUNU DUSUNUN.

##### Sonra başa donup bir tane
### workspace -a mysql 
##### adında bir workspace oluşturup herşeyi sıfırlayarak baştan yaptım butun enum işlemlerini karşıtı çünkü.

---
### Şimdi az önceki modullerde credentials'i aldıktan sonra hiç bir pestester bu şekilde devam etmez çünkü kali de mysql'e uzaktan erişme imkanın var eğer elinde varsa . 




---
## MYSQL QUERY
#mysql-query

```
mysql -h 10.0.2.5 -u root -p 
```
![[Pasted image 20240222002618.png]]

MySQL [(none)]> show databases;
![[Pasted image 20240222004009.png]]
MySQL [(none)]> use mysql;
![[Pasted image 20240222004033.png]]
```
MySQL [mysql]> SELECT * FROM user;
```
![[Pasted image 20240222004106.png]]
MySQL [mysql]> SELECT User, Password FROM user;

![[Pasted image 20240222004120.png]]

---

## SSH Enumeration

### #ssh-msfconsole

+ We can utilize auxiliary modules to enumerate the version of SSH running on the target as well as <span style="background:#d4b106">perform brute-force attacks</span> to identify passwords that can consequently provide us remote access to a target.

### Son dönemlerde şirketler SSH portlarını port 22'den başka yerlere taşıyıp attacker'ların ssh olmadığını düşünmelerini sağlamaya çalışıyor ama bu nafile. port taraması 65535 porta birden yapıyorlar.

---
## Enumeration Başlasın
### workspace oluşturmayı unutma

workspace -a SSH_enum


---
### search ssh version type:auxiliary
![[Pasted image 20240222105219.png]]
![[Pasted image 20240222105429.png]]

---

### Version'u bulduktan sonra eğer bu versiyon için zaafiyet arattık yoksa bir username yakalayıp brute force deneyebiliriz veya direk hem user name hem pass veren wordlistler kullanıp da bruteforce yapabiliriz.

##### msf6 > search ssh_login type:auxiliary
![[Pasted image 20240222105832.png]]
![[Pasted image 20240222110013.png]]

![[Pasted image 20240222110140.png]]

## <span style="background:#d4b106">ÇOK ÖNEMLİ</span>
### Eğer  ise hedef password authentication kullanıyorsa bu modul kullanılır

## 0  auxiliary/scanner/ssh/ssh_login     

### AMA eğer hedef "PUBLIC VEYA KEY-PAIR AUTHENTICATION"   kullanıyorsa bu modul kullanılır
#### 1  auxiliary/scanner/ssh/ssh_login_pubkey                   
### MSFCONSOLE YETMEZ DİYOORR VE SSH İLE KENDİSİ BAĞLANIP SHELL BİLE ALIYOR.
##### SESSIONS -L YAPTIGIMIZDA DIREK GORURUZ


---
---

## SSH ENUM USERS
### search ssh_enumusers
![[Pasted image 20240222111919.png]]

### Bu modul elimizde hiç username yoksa bunu bulmak ve denemek için kullanılabilir.
![[Pasted image 20240222112326.png]]
### Alex'in yapmış olduğu enum da username'ler çıktı bunlara tek tek bruteforce uygulanabilir. Aralarında bir tanesi güçsüz parola yazmışsa geçmiş olsun. Şirket gğvenliği en zayıf halka kadardır.

---

## SMTP Enumeration -- 
## Mail Protocol
#smtp #smtp-enumeration #smtp-msfconsole


+ SMTP (Simple Mail Transfer Protocol) is a communication protocol that is used for the
##### <span style="background:#d4b106">transmission of email.</span>
+ SMTP uses TCP port 25 by default. It is can also be configured to run on TCP port 465 and 587.
+ ### #port25 #port465 #port587 
+ We can utilize auxiliary modules to enumerate the version of SMTP as well as user accounts on the target system.


---
### msf6 > search smtp type:auxiliary

![[Pasted image 20240222112925.png]]
![[Pasted image 20240222113237.png]]

### Şimdi diğer modullere göre bu daha geri planda kalmış olarak gözükebilir. Bu yanlıştır çünkü her bilgi çok önemlidir. Burada yakalayacağınız küçücük bir username SSH'brute force de kullanmanıza yarayabilir. Veya SMTP'ye yapılan bir brute force sonrası alınan password sistemde başka yerlerde kullanılıyor olabilir. 

## Başka mesleklerde bu geçerli olamayabilir ama her bilgi her enumeration çok çok çok önemlidir pentester'lıkta.



---
![[Pasted image 20240222114115.png]]
### VErsiyonu bulduk

---
## Smtp_enum 
### auxiliary/scanner/smtp/smtp_enum 


![[Pasted image 20240222114407.png]]


![[Pasted image 20240222114501.png]]

## VRFY confirmation valid users
## EXPN mailing list


![[Pasted image 20240222114658.png]]


---




